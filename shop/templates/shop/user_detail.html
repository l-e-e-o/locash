{% extends 'shop/base.html' %}
{% block content %}
  <h2>{{ user.display_name }} ({{ user.username }})</h2>
  <p><strong>ID:</strong> {{ user.id12 }}<br><strong>Guthaben:</strong> {{ user.balance }}€</p>

  <h4>Letzte 5 Transaktionen</h4>
  <ul class="list-group mb-3">
    {% for t in last_transactions %}
      <li class="list-group-item">
        {{ t.timestamp }} - {{ t.get_tx_type_display }} - {{ t.amount }}€
        {% if t.product %} - {{ t.product.name }}{% endif %}
        {% if t.to_user %} - an {{ t.to_user.display_name }}{% endif %}
      </li>
    {% empty %}
      <li class="list-group-item">Keine Transaktionen.</li>
    {% endfor %}
  </ul>

  <div class="row">
    <div class="col-md-4">
      <h5>Guthaben aufladen</h5>
      <form method="post">{% csrf_token %}
        {{ topup_form.amount }}
        <input type="hidden" name="action" value="topup">
        <div class="mb-2"><button class="btn btn-primary">Aufladen</button></div>
      </form>

      <div class="btn-group" role="group">
        <form method="post" style="display:inline;">{% csrf_token %}
          <input type="hidden" name="action" value="topup_quick">
          <input type="hidden" name="amount" value="5.00">
          <button class="btn btn-outline-secondary">5€</button>
        </form>
        <form method="post" style="display:inline;">{% csrf_token %}
          <input type="hidden" name="action" value="topup_quick">
          <input type="hidden" name="amount" value="10.00">
          <button class="btn btn-outline-secondary">10€</button>
        </form>
        <form method="post" style="display:inline;">{% csrf_token %}
          <input type="hidden" name="action" value="topup_quick">
          <input type="hidden" name="amount" value="20.00">
          <button class="btn btn-outline-secondary">20€</button>
        </form>
        <form method="post" style="display:inline;">{% csrf_token %}
          <input type="hidden" name="action" value="topup_quick">
          <input type="hidden" name="amount" value="50.00">
          <button class="btn btn-outline-secondary">50€</button>
        </form>
      </div>

      <hr>
      <form method="post">{% csrf_token %}
        <input type="hidden" name="action" value="undo_last">
        <button class="btn btn-danger">Letzte Transaktion rückgängig machen</button>
      </form>
    </div>

    <div class="col-md-4">
      <h5>Produkte kaufen</h5>
      <ul class="list-group">
        {% for p in products %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ p.name }}</strong><br>{{ p.price }}€<br>
          </div>
          <form method="post" style="margin-left:10px;">{% csrf_token %}
            <input type="hidden" name="action" value="buy">
            <input type="hidden" name="product_id" value="{{ p.id12 }}">
            <button class="btn btn-success">Kaufen</button>
          </form>
        </li>
        {% endfor %}
      </ul>

      <hr>
      <h6>Produkt per ID kaufen</h6>
      <form method="post">{% csrf_token %}
        <input id="product_id_input" name="product_id" class="form-control" placeholder="12-stellige Produkt ID">
        <input type="hidden" name="action" value="buy_by_id">
        <button class="btn btn-primary mt-2">Kaufen</button>
      </form>
    </div>

    <div class="col-md-4">
        <h5>Geld schicken</h5>
        <form method="post">{% csrf_token %}
            <input type="hidden" name="action" value="send">
            {{ send_form.to_user_username.label_tag }}
            {{ send_form.to_user_username }}
            {{ send_form.amount.label_tag }}
            {{ send_form.amount }}
            <div class="mt-2"><button class="btn btn-primary">Senden</button></div>
        </form>

        <hr>
        <h5>Geld entnehmen</h5>
        <form method="post">{% csrf_token %}
            <input type="hidden" name="action" value="withdraw">
            <input name="amount" type="number" step="0.01" min="0.01" class="form-control" placeholder="Betrag">
            <div class="mt-2"><button class="btn btn-warning">Entnehmen</button></div>
        </form>
    </div>

<script>
  const prodInput = document.getElementById('product_id_input');
  if (prodInput) prodInput.focus();

  setTimeout(() => { window.location.href = "{% url 'index' %}"; }, 30000);
</script>
{% endblock %}
